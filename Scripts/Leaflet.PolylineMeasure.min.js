(function(n){if(typeof define=="function"&&define.amd)define(["leaflet"],n);else if(typeof module!="undefined")module.exports=n(require("leaflet"));else{if(typeof L=="undefined")throw new Error("Leaflet must be loaded first");n(window.L)}})(function(n){var i="polyline-measure-control",t="polyline-measure-unicode-icon";return n.Control.PolylineMeasure=n.Control.extend({options:{position:"topleft",unit:"metres",clearMeasurementsOnStop:!0,showBearings:!1,bearingTextIn:"In",bearingTextOut:"Out",tooltipTextDraganddelete:"Click and drag to <b>move point<\/b><br>Press ALT-key and click to <b>delete point<\/b>",tooltipTextResume:"<br>Press CTRL-key and click to <b>resume line<\/b>",tooltipTextAdd:"Press CTRL-key and click to <b>add point<\/b>",measureControlTitleOn:"Turn on PolylineMeasure",measureControlTitleOff:"Turn off PolylineMeasure",measureControlLabel:"&#8614;",measureControlClasses:[],showClearControl:!1,clearControlTitle:"Clear Measurements",clearControlLabel:"&times;",clearControlClasses:[],showUnitControl:!1,unitControlTitle:{text:"Change Units",metres:"metres",landmiles:"land miles",nauticalmiles:"nautical miles"},unitControlLabel:{metres:"m",kilometres:"km",feet:"ft",landmiles:"mi",nauticalmiles:"nm"},tempLine:{color:"#00f",weight:2},fixedLine:{color:"#006",weight:2},startCircle:{color:"#000",weight:1,fillColor:"#0f0",fillOpacity:1,radius:3},intermedCircle:{color:"#000",weight:1,fillColor:"#ff0",fillOpacity:1,radius:3},currentCircle:{color:"#000",weight:1,fillColor:"#f0f",fillOpacity:1,radius:6},endCircle:{color:"#000",weight:1,fillColor:"#f00",fillOpacity:1,radius:3}},_createControl:function(t,i,r,u,f,e){var o=document.createElement("a");o.innerHTML=t;o.setAttribute("title",i);r.forEach(function(n){o.classList.add(n)});n.DomEvent.on(o,"click",f,e);return u.appendChild(o),o},onAdd:function(){var r,u,f;this._container=document.createElement("div");this._container.classList.add("leaflet-bar");n.DomEvent.disableClickPropagation(this._container);var u=this.options.measureControlTitleOn,r=this.options.measureControlLabel,f=this.options.measureControlClasses;if(r.indexOf("&")!=-1&&f.push(t),this._arrPolylines=[],this._measureControl=this._createControl(r,u,f,this._container,this._toggleMeasure,this),this._defaultControlBgColor=this._measureControl.style.backgroundColor,this._measureControl.setAttribute("id",i),this.options.showClearControl){var u=this.options.clearControlTitle,r=this.options.clearControlLabel,f=this.options.clearControlClasses;r.indexOf("&")!=-1&&f.push(t);this._clearMeasureControl=this._createControl(r,u,f,this._container,this._clearAllMeasurements,this);this._clearMeasureControl.classList.add("polyline-measure-clearControl")}return this.options.showUnitControl&&(this.options.unit=="metres"?(r=this.options.unitControlLabel.metres,u=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle.metres+"]"):this.options.unit=="landmiles"?(r=this.options.unitControlLabel.landmiles,u=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle.landmiles+"]"):(r=this.options.unitControlLabel.nauticalmiles,u=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle.nauticalmiles+"]"),f=[],this._unitControl=this._createControl(r,u,f,this._container,this._changeUnit,this),this._unitControl.setAttribute("id","unitControlId")),this._container},onRemove:function(){this._measuring&&this._toggleMeasure()},_toggleMeasure:function(){if(this._measuring=!this._measuring,this._measuring){this._measureControl.classList.add("polyline-measure-controlOnBgColor");this._measureControl.style.backgroundColor=this.options.backgroundColor;this._measureControl.title=this.options.measureControlTitleOff;this._oldCursor=this._map._container.style.cursor;this._map._container.style.cursor="crosshair";this._doubleClickZoom=this._map.doubleClickZoom.enabled();this._map.doubleClickZoom.disable();this._layerPaint||(this._layerPaint=n.layerGroup().addTo(this._map));this._map.on("mousemove",this._mouseMove,this);this._map.on("click",this._mouseClick,this);n.DomEvent.on(document,"keydown",this._onKeyDown,this);this._resetPathVariables()}else this._measureControl.classList.remove("polyline-measure-controlOnBgColor"),this._measureControl.style.backgroundColor=this._defaultControlBgColor,this._measureControl.title=this.options.measureControlTitleOn,this._map._container.style.cursor=this._oldCursor,this._map.off("mousemove",this._mouseMove,this),this._map.off("click",this._mouseClick,this),n.DomEvent.off(document,"keydown",this._onKeyDown,this),this._doubleClickZoom&&this._map.doubleClickZoom.enable(),this.options.clearMeasurementsOnStop&&this._layerPaint&&this._clearAllMeasurements(),this._cntCircle!==0&&this._finishPolylinePath();this._map.fire("polylinemeasure:toggle",{sttus:this._measuring})},_clearAllMeasurements:function(){this._cntCircle!==undefined&&this._cntCircle!==0&&this._finishPolylinePath();this._layerPaint&&this._layerPaint.clearLayers();this._arrPolylines=[]},_changeUnit:function(){this.options.unit=="metres"?(this.options.unit="landmiles",document.getElementById("unitControlId").innerHTML=this.options.unitControlLabel.landmiles,this._unitControl.title=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle.landmiles+"]"):this.options.unit=="landmiles"?(this.options.unit="nauticalmiles",document.getElementById("unitControlId").innerHTML=this.options.unitControlLabel.nauticalmiles,this._unitControl.title=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle.nauticalmiles+"]"):(this.options.unit="metres",document.getElementById("unitControlId").innerHTML=this.options.unitControlLabel.metres,this._unitControl.title=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle.metres+"]");this._arrPolylines.map(function(n){var t=0;n.circleCoords.map(function(i,r){if(r>=1){var u=n.circleCoords[r-1].distanceTo(n.circleCoords[r]);t+=u;this._updateTooltip(n.tooltips[r],n.tooltips[r-1],t,u,n.circleCoords[r-1],n.circleCoords[r])}}.bind(this))}.bind(this))},_onKeyDown:function(n){if(n.keyCode===27){if(resumeFirstpointFlag===!0){resumeFirstpointFlag=!1;this._map.off("mousemove",this._resumeFirstpointMousemove,this);this._map.off("click",this._resumeFirstpointClick,this);this._layerPaint.removeLayer(this._rubberlinePath2);this._layerPaint.removeLayer(tooltipNew);this._arrPolylines[lineNr].circleMarkers[0].setStyle(this.options.startCircle);text="";var t=0;this.options.showBearings===!0&&(text=this.options.bearingTextIn+":---°<br>"+this.options.bearingTextOut+":---°");text=text+'<div class="polyline-measure-tooltip-difference">+0<\/div>';text=text+'<div class="polyline-measure-tooltip-total">0<\/div>';this._arrPolylines[lineNr].tooltips[0]._icon.innerHTML=text;this._arrPolylines[lineNr].tooltips.map(function(n,i){var u;if(i>=1){var r=this._arrPolylines[lineNr].circleCoords[i-1].distanceTo(this._arrPolylines[lineNr].circleCoords[i]),f=this._arrPolylines[lineNr].circleCoords[i-1],e=this._arrPolylines[lineNr].circleCoords[i];t+=r;u=this._arrPolylines[lineNr].tooltips[i-1];this._updateTooltip(n,u,t,r,f,e)}}.bind(this));this._map.on("mousemove",this._mouseMove,this);return}this._currentLine?this._finishPolylinePath(n):this._toggleMeasure()}},_getDistance:function(n){var t=n;return this.options.unit==="nauticalmiles"?(unit=this.options.unitControlLabel.nauticalmiles,t>=1852e3?t=(t/1852).toFixed(0):t>=185200?t=(t/1852).toFixed(1):t>=1852?t=(t/1852).toFixed(2):(t=(t/.3048).toFixed(0),unit=this.options.unitControlLabel.feet)):this.options.unit==="landmiles"?(unit=this.options.unitControlLabel.landmiles,t>=1609344?t=(t/1609.344).toFixed(0):t>=160934.4?t=(t/1609.344).toFixed(1):t>=1609.344?t=(t/1609.344).toFixed(2):(t=(t/.3048).toFixed(0),unit=this.options.unitControlLabel.feet)):(unit=this.options.unitControlLabel.kilometres,t>=1e6?t=(t/1e3).toFixed(0):t>=1e5?t=(t/1e3).toFixed(1):t>=1e3?t=(t/1e3).toFixed(2):(t=t.toFixed(1),unit=this.options.unitControlLabel.metres)),{value:t,unit:unit}},_polylineArc:function(n,t){function e(n){function t(n){return Math[n>0?"floor":"ceil"](n)}return A=Math.sin((1-n)*d)/Math.sin(d),B=Math.sin(n*d)/Math.sin(d),x=A*Math.cos(i)*Math.cos(r)+B*Math.cos(u)*Math.cos(f),y=A*Math.cos(i)*Math.sin(r)+B*Math.cos(u)*Math.sin(f),z=A*Math.sin(i)+B*Math.sin(u),latInterpol=180/Math.PI*Math.atan2(z,Math.sqrt(Math.pow(x,2)+Math.pow(y,2))),lngInterpol=180/Math.PI*Math.atan2(y,x),diff=lngInterpol-r*180/Math.PI,lngInterpol=diff<0?lngInterpol-t((diff-180)/360)*360:lngInterpol-t((diff+180)/360)*360,[latInterpol,lngInterpol]}function o(n){var i,t,r,u;for(arrArcCoords=[],i=1/(n-1),t=0;t<n;t++)r=i*t,u=e(r),arrArcCoords.push(u);return arrArcCoords}var i=n.lat,r=n.lng,u=t.lat,f=t.lng;return i=i*Math.PI/180,r=r*Math.PI/180,u=u*Math.PI/180,f=f*Math.PI/180,d=2*Math.asin(Math.sqrt(Math.pow(Math.sin((i-u)/2),2)+Math.cos(i)*Math.cos(u)*Math.pow(Math.sin((r-f)/2),2))),d===0?arrLatLngs=[[i,r]]:(arcpoints=100,arrLatLngs=o(arcpoints)),arrLatLngs},_updateTooltip:function(n,t,i,r,u,f){var h;calcAngle=function(n,t,i){var u=n.lat/180*Math.PI,r=t.lat/180*Math.PI,f=n.lng/180*Math.PI,e=t.lng/180*Math.PI,o=Math.sin(e-f)*Math.cos(r),s=Math.cos(u)*Math.sin(r)-Math.sin(u)*Math.cos(r)*Math.cos(e-f),h;return h=i==="inbound"?(Math.atan2(o,s)*180/Math.PI+180).toFixed(0):(Math.atan2(o,s)*180/Math.PI+360).toFixed(0),h%360};var c=calcAngle(f,u,"inbound"),l=calcAngle(u,f,"outbound"),s=this._getDistance(i),o=this._getDistance(r),e="";o.value>0&&(this.options.showBearings===!0&&(e=this.options.bearingTextIn+": "+c+"°<br>"+this.options.bearingTextOut+":---°"),e+='<div class="polyline-measure-tooltip-difference">+'+o.value+"&nbsp;"+o.unit+"<\/div>");e+='<div class="polyline-measure-tooltip-total">'+s.value+"&nbsp;"+s.unit+"<\/div>";n._icon.innerHTML=e;this.options.showBearings===!0&&t&&(textPrev=t._icon.innerHTML,h=new RegExp(this.options.bearingTextOut+".*°"),textReplace=textPrev.replace(h,this.options.bearingTextOut+": "+l+"°"),t._icon.innerHTML=textReplace)},_drawArrow:function(t){var i=t[48],r=t[49],u=r[1]-i[1],f=r[0]-i[0],e=[i[0]+f/2,i[1]+u/2],o=-Math.atan2(f,u)*57.29578;iconArrow=n.divIcon({className:"",iconSize:[16,16],iconAnchor:[8,8],html:"<div style = 'font-size: 16px; line-height: 16px; vertical-align:top; transform: rotate("+o+"deg)'>&#x27a4;<\/div>"});newArrowMarker=n.marker(e,{icon:iconArrow}).addTo(this._layerPaint);newArrowMarker.bindTooltip(this.options.tooltipTextAdd,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});newArrowMarker.on("click",this._clickedArrow,this);return newArrowMarker},_mouseMove:function(n){var t=n.latlng,i,r,f,u;this._map.on("click",this._mouseClick,this);t&&this._currentLine&&(i=this._currentLine.circleCoords.last(),this._rubberlinePath.setLatLngs(this._polylineArc(i,t)),r=this._currentLine.tooltips.last(),f=this._currentLine.tooltips.slice(-2,-1)[0],r.setLatLng(t),u=t.distanceTo(i),this._updateTooltip(r,f,this._currentLine.distance+u,u,i,t))},_startLine:function(t){var u=n.divIcon({className:"polyline-measure-tooltip",iconAnchor:[-4,-4]}),r=function(){return this.slice(-1)[0]},i;this._rubberlinePath=n.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:!1,dashArray:"8,8"}).addTo(this._layerPaint).bringToBack();i=this;this._currentLine={id:0,circleCoords:[],circleMarkers:[],arrowMarkers:[],tooltips:[],distance:0,polylinePath:n.polyline([],{color:this.options.fixedLine.color,weight:this.options.fixedLine.weight,interactive:!1}).addTo(this._layerPaint).bringToBack(),handleMarkers:function(t){var u=this.circleMarkers.last(),r;u&&(u.off("click",i._finishPolylinePath,i),this.circleMarkers.length===1?(u.setStyle(i.options.startCircle),u.unbindTooltip(),u.bindTooltip(i.options.tooltipTextDraganddelete+i.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"})):u.setStyle(i.options.intermedCircle));r=new n.CircleMarker(t,i.options.currentCircle).addTo(i._layerPaint);r.bindTooltip(i.options.tooltipTextDraganddelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});r.cntLine=i._currentLine.id;r.cntCircle=i._cntCircle;i._cntCircle++;r.on("mousedown",i._dragCircle,i);r.on("click",i._finishPolylinePath,i);this.circleMarkers.push(r)},getNewToolTip:function(t){return n.marker(t,{icon:u,interactive:!1})},addPoint:function(n){var t=this.circleCoords.last(),r,u,f,o,e;t&&t.equals(n)||(this.circleCoords.push(n),this.circleCoords.length>1&&(r=i._polylineArc(t,n),this.circleCoords.length>2&&r.shift(),this.polylinePath.setLatLngs(this.polylinePath.getLatLngs().concat(r)),u=i._drawArrow(r),u.cntLine=i._currentLine.id,u.cntArrow=i._cntCircle-1,i._currentLine.arrowMarkers.push(u),distanceSegment=t.distanceTo(n),this.distance+=distanceSegment,f=i._currentLine.tooltips.last(),o=i._currentLine.tooltips.slice(-1,-2)[0],i._updateTooltip(f,o,this.distance,distanceSegment,t,n)),f&&f.setLatLng(n),e=this.getNewToolTip(n),e.addTo(i._layerPaint),this.tooltips.push(e),this.handleMarkers(n))},finalize:function(){if(i._layerPaint.removeLayer(this.tooltips.last()),this.tooltips.pop(),i._layerPaint.removeLayer(i._rubberlinePath),this.circleCoords.length>1){this.tooltips.last()._icon.classList.add("polyline-measure-tooltip-end");var n=this.circleMarkers.last();n.setStyle(i.options.endCircle);n.unbindTooltip();n.bindTooltip(i.options.tooltipTextDraganddelete+i.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});n.off("click",i._finishPolylinePath,i);n.on("click",i._resumePolylinePath,i);i._arrPolylines.push(this)}else i._layerPaint.removeLayer(this.circleMarkers.last());i._resetPathVariables()}};firstTooltip=n.marker(t,{icon:u,interactive:!1});firstTooltip.addTo(this._layerPaint);text="";this.options.showBearings===!0&&(text=this.options.bearingTextIn+":---°<br>"+this.options.bearingTextOut+":---°");text=text+'<div class="polyline-measure-tooltip-difference">+0<\/div>';text=text+'<div class="polyline-measure-tooltip-total">0<\/div>';firstTooltip._icon.innerHTML=text;this._currentLine.tooltips.push(firstTooltip);this._currentLine.circleCoords.last=r;this._currentLine.tooltips.last=r;this._currentLine.circleMarkers.last=r;this._currentLine.id=this._arrPolylines.length},_mouseClick:function(n){!n.latlng||this._finishCircleScreencoords&&this._finishCircleScreencoords.equals(n.containerPoint)||(this._currentLine||this._startLine(n.latlng),this._currentLine.addPoint(n.latlng))},_finishPolylinePath:function(n){this._currentLine.finalize();n&&(this._finishCircleScreencoords=n.containerPoint)},_resumePolylinePath:function(t){if(t.originalEvent.ctrlKey===!0){this._currentLine=this._arrPolylines[t.target.cntLine];this._rubberlinePath=n.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:!1,dashArray:"8,8"}).addTo(this._layerPaint).bringToBack();this._currentLine.tooltips.last()._icon.classList.remove("polyline-measure-tooltip-end");var i=this._currentLine.getNewToolTip(t.latlng);i.addTo(this._layerPaint);this._currentLine.tooltips.push(i);this._currentLine.circleMarkers.last().unbindTooltip();this._currentLine.circleMarkers.last().bindTooltip(this.options.tooltipTextDraganddelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});this._currentLine.circleMarkers.last().setStyle(this.options.currentCircle);this._cntCircle=this._currentLine.circleCoords.length}},_resetPathVariables:function(){this._cntCircle=0;this._currentLine=null},_clickedArrow:function(t){var i,r,u,f,e,o;if(t.originalEvent.ctrlKey){i=t.target.cntLine;r=t.target.cntArrow;this._arrPolylines[i].arrowMarkers[r].removeFrom(this._layerPaint);u=new n.CircleMarker(t.latlng,this.options.intermedCircle).addTo(this._layerPaint);u.cntLine=i;u.on("mousedown",this._dragCircle,this);u.bindTooltip(this.options.tooltipTextDraganddelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});this._arrPolylines[i].circleMarkers.splice(r+1,0,u);this._arrPolylines[i].circleMarkers.map(function(n,t){n.cntCircle=t});this._arrPolylines[i].circleCoords.splice(r+1,0,t.latlng);lineCoords=this._arrPolylines[i].polylinePath.getLatLngs();f=this._polylineArc(this._arrPolylines[i].circleCoords[r],t.latlng);f.pop();e=this._polylineArc(t.latlng,this._arrPolylines[i].circleCoords[r+2]);Array.prototype.splice.apply(lineCoords,[r*(arcpoints-1),arcpoints].concat(f,e));this._arrPolylines[i].polylinePath.setLatLngs(lineCoords);arrowMarker=this._drawArrow(f);this._arrPolylines[i].arrowMarkers[r]=arrowMarker;arrowMarker=this._drawArrow(e);this._arrPolylines[i].arrowMarkers.splice(r+1,0,arrowMarker);this._arrPolylines[i].arrowMarkers.map(function(n,t){n.cntLine=i;n.cntArrow=t});tooltipNew=n.marker(t.latlng,{icon:n.divIcon({className:"polyline-measure-tooltip",iconAnchor:[-4,-4]}),interactive:!1});tooltipNew.addTo(this._layerPaint);this._arrPolylines[i].tooltips.splice(r+1,0,tooltipNew);o=0;this._arrPolylines[i].tooltips.map(function(n,t){var u;if(t>=1){var r=this._arrPolylines[i].circleCoords[t-1].distanceTo(this._arrPolylines[i].circleCoords[t]),f=this._arrPolylines[i].circleCoords[t-1],e=this._arrPolylines[i].circleCoords[t];o+=r;u=this._arrPolylines[i].tooltips[t-1];this._updateTooltip(n,u,o,r,f,e)}}.bind(this))}},_dragCircleMouseup:function(){circleNr===0||circleNr===this._arrPolylines[lineNr].circleCoords.length-1?this._e1.target.bindTooltip(this.options.tooltipTextDraganddelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}):this._e1.target.bindTooltip(this.options.tooltipTextDraganddelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});this._resetPathVariables();this._map.off("mousemove",this._dragCircleMousemove,this);this._map.dragging.enable();this._map.on("mousemove",this._mouseMove,this);this._map.off("mouseup",this._dragCircleMouseup,this)},_dragCircleMousemove:function(t){var u=t.latlng.lat,f=t.latlng.lng,e=u-this._mouseStartingLat,o=f-this._mouseStartingLng,i=n.latLng(this._circleStartingLat+e,this._circleStartingLng+o),r;lineNr=this._e1.target.cntLine;circleNr=this._e1.target.cntCircle;this._e1.target.setLatLng(i);this._e1.target.unbindTooltip();this._arrPolylines[lineNr].circleCoords[circleNr]=i;lineCoords=this._arrPolylines[lineNr].polylinePath.getLatLngs();circleNr>=1&&(newLineSegment1=this._polylineArc(this._arrPolylines[lineNr].circleCoords[circleNr-1],i),Array.prototype.splice.apply(lineCoords,[(circleNr-1)*(arcpoints-1),arcpoints].concat(newLineSegment1)),arrowMarker=this._drawArrow(newLineSegment1),arrowMarker.cntLine=lineNr,arrowMarker.cntArrow=circleNr-1,this._arrPolylines[lineNr].arrowMarkers[circleNr-1].removeFrom(this._layerPaint),this._arrPolylines[lineNr].arrowMarkers[circleNr-1]=arrowMarker);circleNr<this._arrPolylines[lineNr].circleCoords.length-1&&(newLineSegment2=this._polylineArc(i,this._arrPolylines[lineNr].circleCoords[circleNr+1]),Array.prototype.splice.apply(lineCoords,[circleNr*(arcpoints-1),arcpoints].concat(newLineSegment2)),arrowMarker=this._drawArrow(newLineSegment2),arrowMarker.cntLine=lineNr,arrowMarker.cntArrow=circleNr,this._arrPolylines[lineNr].arrowMarkers[circleNr].removeFrom(this._layerPaint),this._arrPolylines[lineNr].arrowMarkers[circleNr]=arrowMarker);this._arrPolylines[lineNr].polylinePath.setLatLngs(lineCoords);circleNr>=0&&this._arrPolylines[lineNr].tooltips[circleNr].setLatLng(i);r=0;this._arrPolylines[lineNr].tooltips.map(function(n,t){var u;if(t>=1){var i=this._arrPolylines[lineNr].circleCoords[t-1].distanceTo(this._arrPolylines[lineNr].circleCoords[t]),f=this._arrPolylines[lineNr].circleCoords[t-1],e=this._arrPolylines[lineNr].circleCoords[t];r+=i;u=this._arrPolylines[lineNr].tooltips[t-1];this._updateTooltip(n,u,r,i,f,e)}}.bind(this));this._map.on("mouseup",this._dragCircleMouseup,this)},_resumeFirstpointMousemove:function(n){var t,u,f;this._map.on("click",this._resumeFirstpointClick,this);t=n.latlng;this._rubberlinePath2.setLatLngs(this._polylineArc(t,currentCircleCoords));tooltipNew.setLatLng(t);var i=0,r=t.distanceTo(this._arrPolylines[lineNr].circleCoords[0]),e=t,o=this._arrPolylines[lineNr].circleCoords[0];i+=r;u=tooltipNew;f=this._arrPolylines[lineNr].tooltips[0];this._updateTooltip(f,u,i,r,e,o);this._arrPolylines[lineNr].tooltips.map(function(n,t){var u;if(t>=1){var r=this._arrPolylines[lineNr].circleCoords[t-1].distanceTo(this._arrPolylines[lineNr].circleCoords[t]),f=this._arrPolylines[lineNr].circleCoords[t-1],e=this._arrPolylines[lineNr].circleCoords[t];i+=r;u=this._arrPolylines[lineNr].tooltips[t-1];this._updateTooltip(n,u,i,r,f,e)}}.bind(this))},_resumeFirstpointClick:function(t){var i,r;resumeFirstpointFlag=!1;this._map.off("mousemove",this._resumeFirstpointMousemove,this);this._map.off("click",this._resumeFirstpointClick,this);this._layerPaint.removeLayer(this._rubberlinePath2);this._arrPolylines[lineNr].circleMarkers[0].setStyle(this.options.intermedCircle);this._arrPolylines[lineNr].circleMarkers[0].unbindTooltip();this._arrPolylines[lineNr].circleMarkers[0].bindTooltip(this.options.tooltipTextDraganddelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});i=new n.CircleMarker(t.latlng,this.options.startCircle).addTo(this._layerPaint);i.cntLine=lineNr;i.cntCircle=0;i.on("mousedown",this._dragCircle,this);i.bindTooltip(this.options.tooltipTextDraganddelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});this._arrPolylines[lineNr].circleMarkers.unshift(i);this._arrPolylines[lineNr].circleMarkers.map(function(n,t){n.cntCircle=t});this._arrPolylines[lineNr].circleCoords.unshift(t.latlng);r=this._polylineArc(t.latlng,currentCircleCoords);arrowMarker=this._drawArrow(r);this._arrPolylines[lineNr].arrowMarkers.unshift(arrowMarker);this._arrPolylines[lineNr].arrowMarkers.map(function(n,t){n.cntLine=lineNr;n.cntArrow=t});r.pop();this._arrPolylines[lineNr].polylinePath.setLatLngs(r.concat(this._arrPolylines[lineNr].polylinePath.getLatLngs()));this._arrPolylines[lineNr].tooltips.unshift(tooltipNew);this._map.on("mousemove",this._mouseMove,this)},_dragCircle:function(t){if(t.originalEvent.ctrlKey){if(this._map.off("click",this._mouseClick,this),t.target.cntCircle===0){resumeFirstpointFlag=!0;lineNr=t.target.cntLine;circleNr=t.target.cntCircle;currentCircleCoords=t.latlng;this._arrPolylines[lineNr].circleMarkers[0].setStyle(this.options.currentCircle);this._rubberlinePath2=n.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:!1,dashArray:"8,8"}).addTo(this._layerPaint).bringToBack();tooltipNew=n.marker(currentCircleCoords,{icon:n.divIcon({className:"polyline-measure-tooltip",iconAnchor:[-4,-4]}),interactive:!1});tooltipNew.addTo(this._layerPaint);text="";this.options.showBearings===!0&&(text=text+this.options.bearingTextIn+":---°<br>"+this.options.bearingTextOut+":---°");text=text+'<div class="polyline-measure-tooltip-difference">+0<\/div>';text=text+'<div class="polyline-measure-tooltip-total">0<\/div>';tooltipNew._icon.innerHTML=text;this._map.off("mousemove",this._mouseMove,this);this._map.on("mousemove",this._resumeFirstpointMousemove,this)}return}if(t.originalEvent.altKey){lineNr=t.target.cntLine;circleNr=t.target.cntCircle;this._arrPolylines[lineNr].circleCoords.splice(circleNr,1);this._arrPolylines[lineNr].circleMarkers[circleNr].removeFrom(this._layerPaint);this._arrPolylines[lineNr].circleMarkers.splice(circleNr,1);this._arrPolylines[lineNr].circleMarkers.map(function(n,t){n.cntCircle=t});lineCoords=this._arrPolylines[lineNr].polylinePath.getLatLngs();this._arrPolylines[lineNr].tooltips[circleNr].removeFrom(this._layerPaint);this._arrPolylines[lineNr].tooltips.splice(circleNr,1);circleNr===0?(this._arrPolylines[lineNr].circleMarkers[0].setStyle(this.options.startCircle),lineCoords.splice(0,arcpoints-1),this._arrPolylines[lineNr].arrowMarkers[circleNr].removeFrom(this._layerPaint),this._arrPolylines[lineNr].arrowMarkers.splice(0,1),text="",this.options.showBearings===!0&&(text=this.options.bearingTextIn+":---°<br>"+this.options.bearingTextOut+":---°"),text=text+'<div class="polyline-measure-tooltip-difference">+0<\/div>',text=text+'<div class="polyline-measure-tooltip-total">0<\/div>',this._arrPolylines[lineNr].tooltips[0]._icon.innerHTML=text):circleNr===this._arrPolylines[lineNr].circleCoords.length?(this._arrPolylines[lineNr].circleMarkers.slice(-1)[0].setStyle(this.options.endCircle),this._arrPolylines[lineNr].tooltips.slice(-1)[0]._icon.classList.add("polyline-measure-tooltip-end"),lineCoords.splice(-(arcpoints-1),arcpoints-1),this._arrPolylines[lineNr].arrowMarkers[circleNr-1].removeFrom(this._layerPaint),this._arrPolylines[lineNr].arrowMarkers.splice(-1,1)):(newLineSegment=this._polylineArc(this._arrPolylines[lineNr].circleCoords[circleNr-1],this._arrPolylines[lineNr].circleCoords[circleNr]),Array.prototype.splice.apply(lineCoords,[(circleNr-1)*(arcpoints-1),2*arcpoints-1].concat(newLineSegment)),this._arrPolylines[lineNr].arrowMarkers[circleNr-1].removeFrom(this._layerPaint),this._arrPolylines[lineNr].arrowMarkers[circleNr].removeFrom(this._layerPaint),arrowMarker=this._drawArrow(newLineSegment),this._arrPolylines[lineNr].arrowMarkers.splice(circleNr-1,2,arrowMarker));this._arrPolylines[lineNr].polylinePath.setLatLngs(lineCoords);this._arrPolylines[lineNr].arrowMarkers.map(function(n,t){n.cntLine=lineNr;n.cntArrow=t});var i=0;this._arrPolylines[lineNr].tooltips.map(function(n,t){var u;if(t>=1){var r=this._arrPolylines[lineNr].circleCoords[t-1].distanceTo(this._arrPolylines[lineNr].circleCoords[t]),f=this._arrPolylines[lineNr].circleCoords[t-1],e=this._arrPolylines[lineNr].circleCoords[t];i+=r;u=this._arrPolylines[lineNr].tooltips[t-1];this._updateTooltip(n,u,i,r,f,e)}}.bind(this));return}if(this._e1=t,this._measuring&&this._cntCircle===0){this._map.dragging.disable();this._map.off("mousemove",this._mouseMove,this);this._map.off("click",this._mouseClick,this);this._mouseStartingLat=t.latlng.lat;this._mouseStartingLng=t.latlng.lng;this._circleStartingLat=t.target._latlng.lat;this._circleStartingLng=t.target._latlng.lng;this._map.on("mousemove",this._dragCircleMousemove,this)}}}),n.Map.mergeOptions({PolylineMeasureControl:!1}),n.Map.addInitHook(function(){this.options.polylineMeasureControl&&(this.PMControl=new n.Control.PolylineMeasure,this.addControl(this.PMControl))}),n.control.polylineMeasure=function(t){return new n.Control.PolylineMeasure(t)},n.Control.PolylineMeasure});