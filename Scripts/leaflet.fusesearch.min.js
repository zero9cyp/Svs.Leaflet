Array.prototype.map||(Array.prototype.map=function(n){var r=this.length,i,u,t;if(typeof n!="function")throw new TypeError;for(i=new Array(r),u=arguments[1],t=0;t<r;t++)t in this&&(i[t]=n.call(u,this[t],t,this));return i});L.Control.FuseSearch=L.Control.extend({includes:L.Evented.prototype,options:{position:"topright",title:"Search",panelTitle:"",placeholder:"Search",caseSensitive:!1,threshold:.5,maxResultLength:null,showResultFct:null,showInvisibleFeatures:!0},initialize:function(n){L.setOptions(this,n);this._panelOnLeftSide=this.options.position.indexOf("left")!==-1},onAdd:function(n){var t=this._createControl();return this._createPanel(n),this._setEventListeners(),n.invalidateSize(),t},onRemove:function(n){return this.hidePanel(n),this._clearEventListeners(),this._clearPanel(n),this._clearControl(),this},_createControl:function(){var i=L.DomUtil.create("div","leaflet-fusesearch-control"),n=this._openButton=L.DomUtil.create("a","button",i),t;n.href="#";n.title=this.options.title;t=L.DomEvent.stopPropagation;L.DomEvent.on(n,"click",t).on(n,"mousedown",t).on(n,"touchstart",t).on(n,"mousewheel",t).on(n,"MozMousePixelScroll",t);L.DomEvent.on(n,"click",L.DomEvent.preventDefault);L.DomEvent.on(n,"click",this.showPanel,this);return i},_clearControl:function(){var n=this._openButton,t=L.DomEvent.stopPropagation;L.DomEvent.off(n,"click",t).off(n,"mousedown",t).off(n,"touchstart",t).off(n,"mousewheel",t).off(n,"MozMousePixelScroll",t);L.DomEvent.off(n,"click",L.DomEvent.preventDefault);L.DomEvent.off(n,"click",this.showPanel)},_createPanel:function(n){var o=this,s=n.getContainer(),t=this._panel=L.DomUtil.create("div","leaflet-fusesearch-panel",s),i=L.DomEvent.stopPropagation,u,r,e,f;L.DomEvent.on(t,"click",i).on(t,"dblclick",i).on(t,"mousedown",i).on(t,"touchstart",i).on(t,"mousewheel",i).on(t,"MozMousePixelScroll",i);this._panelOnLeftSide?L.DomUtil.addClass(t,"left"):L.DomUtil.addClass(t,"right");u=L.DomUtil.create("div","content",t);r=L.DomUtil.create("div","header",u);this.options.panelTitle&&(e=L.DomUtil.create("p","panel-title",r),e.innerHTML=this.options.panelTitle);L.DomUtil.create("img","search-image",r);this._input=L.DomUtil.create("input","search-input",r);this._input.maxLength=30;this._input.placeholder=this.options.placeholder;this._input.onkeyup=function(n){var t=n.currentTarget.value;o.searchFeatures(t)};f=this._closeButton=L.DomUtil.create("a","close",r);f.innerHTML="&times;";L.DomEvent.on(f,"click",this.hidePanel,this);return this._resultList=L.DomUtil.create("div","result-list",u),t},_clearPanel:function(n){var t=L.DomEvent.stopPropagation,i;L.DomEvent.off(this._panel,"click",t).off(this._panel,"dblclick",t).off(this._panel,"mousedown",t).off(this._panel,"touchstart",t).off(this._panel,"mousewheel",t).off(this._panel,"MozMousePixelScroll",t);L.DomEvent.off(this._closeButton,"click",this.hidePanel);i=n.getContainer();i.removeChild(this._panel);this._panel=null},_setEventListeners:function(){var n=this,t=this._input;this._map.addEventListener("overlayadd",function(){n.searchFeatures(t.value)});this._map.addEventListener("overlayremove",function(){n.searchFeatures(t.value)})},_clearEventListeners:function(){this._map.removeEventListener("overlayadd");this._map.removeEventListener("overlayremove")},isPanelVisible:function(){return L.DomUtil.hasClass(this._panel,"visible")},showPanel:function(){this.isPanelVisible()||(L.DomUtil.addClass(this._panel,"visible"),this._map.panBy([this.getOffset()*.5,0],{duration:.5}),this.fire("show"),this._input.select(),this.searchFeatures(this._input.value))},hidePanel:function(n){this.isPanelVisible()&&(L.DomUtil.removeClass(this._panel,"visible"),null!==this._map&&this._map.panBy([this.getOffset()*-.5,0],{duration:.5}),this.fire("hide"),n&&L.DomEvent.stopPropagation(n))},getOffset:function(){return this._panelOnLeftSide?-this._panel.offsetWidth:this._panel.offsetWidth},indexFeatures:function(n,t){var u=n.features||n,i,r;this._keys=t;i=u.map(function(n){return n.properties._feature=n,n.properties});r={keys:t,caseSensitive:this.options.caseSensitive,threshold:this.options.threshold};this._fuseIndex=new Fuse(i,r)},searchFeatures:function(n){for(var i=this._fuseIndex.search(n),r=document.querySelectorAll(".result-item"),t=0;t<r.length;t++)r[t].remove();var o=document.querySelector(".result-list"),s=0,u=this.options.maxResultLength;for(t in i){var f=i[t],h=f._feature,e=this._getFeaturePopupIfVisible(h);if((undefined!==e||this.options.showInvisibleFeatures)&&(this.createResultItem(f,o,e),undefined!==u&&++s===u))break}},refresh:function(){this.isPanelVisible()&&this.searchFeatures(this._input.value)},_getFeaturePopupIfVisible:function(n){var t=n.layer;if(undefined!==t&&this._map.hasLayer(t))return t.getPopup()},createResultItem:function(n,t,i){var e=this,f=n._feature,r=L.DomUtil.create("p","result-item",t),u;if(undefined!==i&&(L.DomUtil.addClass(r,"clickable"),r.onclick=function(){window.matchMedia("(max-width:480px)").matches?(e.hidePanel(),f.layer.openPopup()):e._panAndPopup(f,i)}),null!==this.options.showResultFct)this.options.showResultFct(f,r);else{for(str="<b>"+n[this._keys[0]]+"<\/b>",u=1;u<this._keys.length;u++)str+="<br/>"+n[this._keys[u]];r.innerHTML=str}return r},_panAndPopup:function(n,t){var i,r;this._panelOnLeftSide?(i=t.options.autoPanPaddingTopLeft,r=new L.Point(-this.getOffset(),10),t.options.autoPanPaddingTopLeft=r,n.layer.openPopup(),t.options.autoPanPaddingTopLeft=i):(i=t.options.autoPanPaddingBottomRight,r=new L.Point(this.getOffset(),10),t.options.autoPanPaddingBottomRight=r,n.layer.openPopup(),t.options.autoPanPaddingBottomRight=i)}});L.control.fuseSearch=function(n){return new L.Control.FuseSearch(n)};